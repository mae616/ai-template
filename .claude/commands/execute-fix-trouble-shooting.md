# [バグ対応] 4. 修正実行を恒久対応・段階実施＋無効時ロールバックでする (引数:トラブルシューティングファイル)

# 修正実行コマンド（恒久対応・段階実施＋無効時ロールバック）

## 入力
- `$ARGUMENTS` : 対象のトラブルシューティングログ（Markdown）ファイルのパス  
  - 例: `ai-task/trouble-shooting/認証失敗.md`

---

## 🎯 目的
- `$ARGUMENTS` に記載された **「修正策（候補一覧）」** を上から順に実行する  
- **恒久対応のみ** を実施（暫定対応はスキップ、または恒久案に置換）  
- 各修正の効果を検証し、**効果なしの場合は修正前の状態へロールバック**  
- すべての修正で効果がない場合、**最終的に完全に元の状態へ戻す**  
- 実施内容・結果を `$ARGUMENTS` に追記し、**解決状況を更新** する

---

## 前提ポリシー（安全運用）
- **安全第一**：本番影響のある操作は別環境で実施、シークレット露出禁止、最小権限  
- **検証必須**：修正ごとに再現テスト／自動テスト／メトリクスで効果判定  
- **可逆性**：修正ごとにコミットを分離、**無効時は即 `git revert`**（または対応するロールバック手順）  
- **恒久性**：一時ファイル削除やタイミング依存などの **暫定策は採用しない**  
- **監査性**：変更差分・ログ・エビデンスを `ai-task/artifacts/` に保存し、ログ本文から参照

---

## 実行手順

1. **ログ読込 & 事前整理**  
   - `$ARGUMENTS` を開き、以下を抽出：  
     - 問題の概要 / 再現手順 / 期待する動作（理想状態） / ギャップ  
     - **修正策（候補一覧）**（仮説ごとの案）  
     - 参考資料（出典）  
   - 検証条件を確定：**再現ケース・成功基準・観測指標・タイムアウト**

2. **変更用ブランチ／スナップショット**  
   - 作業ブランチ例：`fix/run-YYYYMMDD-HHmm`  
   - 影響ファイルのバックアップ、`git status` スナップショット取得

3. **修正案の逐次実行ループ**  
   - 各案ごとに以下を行う：  
     a. 変更を最小コミットで適用（1案＝1コミット）  
     b. **検証**：再現手順・自動テスト・メトリクスで効果判定  
     c. **判定**  
        - **効果あり**：コミットを保持、対応履歴に成功内容を記録。  
          - 問題が解消し **成功基準を満たしたらループ終了**（他案は未実施のまま）。  
        - **効果なし**：エキスパートエンジニアの知識を用いて、  
          現実的かつ理論的に恒久的な改善として残すべきと判断できるもの以外は、  
          **即ロールバック**（`git revert` or 手順どおり戻す）。  
          その際、対応履歴に失敗内容と根拠を記録。  

4. **ログ更新（$ARGUMENTS へ追記）**  
   - `### 対応履歴（時系列）`：各案の **適用 → 検証 → 成否 → ロールバック有無** を追記  
   - `### 解決状況`：状態を更新（🟢完了 / 🔵テスト中 / 🟠対応中 / 🟡調査中）  
   - `### 修正策（候補一覧）`：採用案に **[採用]**、不採用案に **[不採用] 理由** を追記  
   - `### 参考資料（出典）`：参照した公式Doc / 公式GitHub / Stack Overflow などを追記  
   - `## 自己評価`：今回の結果で更新

5. **成果物の保存**  
   - 変更差分、テストログ、計測スクショ等を `ai-task/artifacts/YYYYMMDD-HHmm/` に保存  
   - 本文から相対リンクを記載

---

## 出力先
- `$ARGUMENTS` のファイルを **直接更新**（差分が必要なら別途 Unified diff を併記可）

---

## ログ追記フォーマット（テンプレ）

### 対応履歴（時系列）
- {時刻} - **修正案A** を適用。{変更概要}。コミット `{short_sha}`。  
- {時刻} - 検証：{再現手順/テスト名/メトリクス} → {結果: 成功/不変/悪化}。  
- {時刻} - {結果に応じた処置：保持 / `git revert {sha}` でロールバック}。  
- {時刻} - 次の修正案へ移行。残課題：{あれば記載}。

### 修正策（候補一覧）
- **仮説A**  
  - **修正案1**: … **[採用/不採用]**（理由：{効果/副作用/整合性など}）  
  - **修正案2**: … **[採用/不採用]**（理由：…）  
- **仮説B**  
  - …

### 解決状況
- **状態**: 🟢完了 / 🔵テスト中 / 🟠対応中 / 🟡調査中  
- **メモ**: {恒久対応の内容 / 監視項目 / 追跡課題 / リリース計画}

### 参考資料（出典）
- [公式Doc] {タイトル} — {URL}  
- [公式GitHub Issue/PR] {番号/タイトル} — {URL}  
- [Stack Overflow] {スレッドタイトル} — {URL}  

---

## 効果判定ガイド
- **成功基準**（例）：  
  - 再現手順で **失敗が再現しない**／エラーログが消失  
  - 該当ユニット/E2Eテストが **安定合格**（n回連続）  
  - 関連メトリクス（エラーレート/レイテンシ/メモリ等）が **閾値内**  
- **失敗基準**：  
  - 事象が継続／別の回帰を誘発／メトリクス悪化／副作用が許容外

---

## 品質チェックリスト
- [ ] 各修正案を **個別コミット** で適用し、可逆性を担保している  
- [ ] **検証条件**（再現ケース・成功基準・メトリクス）が明確  
- [ ] 効果なしの修正は **即ロールバック**（恒久改善と判断できる場合を除く）  
- [ ] 暫定対応を避け、**恒久対応のみ** 実施している  
- [ ] 対応履歴に **適用→検証→成否→ロールバック** が時系列で記録  
- [ ] 参考資料（公式Doc / 公式GitHub / Stack Overflow）が明記  
- [ ] 最終的な **解決状況** が適切に更新されている  
- [ ] アーティファクト（差分・ログ・証跡）へのリンクが記載されている

---

## 自己評価
- **成功自信度**: (1-10)  
- **一言理由**: {短く理由を記載。例: 「再現テストで5回連続合格・関連メトリクスも安定」}
